<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>lazzzis</title>
  <link rel="icon" href="favicon.ico"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css/ionicons.min.css">
  <link rel="stylesheet" href="/css/milligram.min.css">
  <link rel="stylesheet" href="/css/comfortaa.css">
  <link rel="stylesheet" href="/css/source-sans-pro.css">
  <link rel="stylesheet" href="/css/animate.min.css">
  <link rel="stylesheet" href="/css/nprogress.css">
  <link rel="stylesheet" href="/css/loaders.min.css">
  <link rel="stylesheet" href="/css/atom-one-light.css">
  <link rel="stylesheet" href="/css/app.css">
</head>
<body>
  <div id="app"></div>
  <template>
    <template>
    <p>大概一年以前，我发布过一个主题，名为 <a href="https://github.com/lazzzis/hexo-theme-mls" target="_blank" rel="noopener">hexo-theme-mls</a>。这个主题是我当时在学完如何写一个 hexo 主题后完成的。后来在学了 vue 之后，构思着再写一个主题。我非常想把它写成一个单页应用，可是一直没有思绪。直到后来看到了 <a href="https://github.com/EYHN/hexo-theme-one" target="_blank" rel="noopener">hexo-theme-one</a>，我才有了思绪，于是开始写一个单页的主题。</p>
<a id="more"></a>
<h1 id="restful"><a href="#restful" class="headerlink" title="restful"></a>restful</h1><p>首先一个问题就是，如何生成 json 文件，用于前端的异步数据请求。<a href="https://github.com/yscoder/hexo-generator-restful" target="_blank" rel="noopener">hexo-generator-restful</a> 提供了很好的思路，hexo 在执行的时候，会载入主题文件夹下的 scripts 下的文件并执行。而 hexo 提供了一个接口，可以用于在读取所有博客内容之后，生成所有文件之前，添加需要生成的文件。</p>
<p><a href="https://hexo.io/api/generator.html" target="_blank" rel="noopener">generator</a> 接口即是需要的接口。注册一个函数，这个函数可以在执行完后返回一个数组，数组每一个元素即是一个将要生成的文件的信息，这个信息包括:</p>

    <pre><code class="lang-js">{
    <span class="hljs-attribute">path</span>: post.path, <span class="hljs-comment">// 路径</span>
    <span class="hljs-attribute">data</span>: post, <span class="hljs-comment">// 这个文件的内容</span>
    <span class="hljs-attribute">layout</span>: <span class="hljs-string">'post'</span> <span class="hljs-comment">// 布局</span>
}
</code></pre>
<p>一般文件生成后会在 public 文件夹下，那么这个路径只要是相对 public 即可，比如 <code>api/posts.json</code>，则会在 <code>public/api/posts.json</code>。至于文件内容，因为这个 data 一般要求是字符串或流 (stream)，所以我选择用 JSON.stringify() 将需要的数据 (对象) 转化为字符串。</p>
<h2 id="那么最终需要生成哪些-json-文件呢"><a href="#那么最终需要生成哪些-json-文件呢" class="headerlink" title="那么最终需要生成哪些 json 文件呢?"></a>那么最终需要生成哪些 json 文件呢?</h2><h3 id="所有的-posts-数据"><a href="#所有的-posts-数据" class="headerlink" title="所有的 posts 数据"></a>所有的 posts 数据</h3><p>一个 <code>posts.json</code> 记录了这个博客所有的博客大概信息 (每篇博客的标题，包含的标签，发布日期等)，但不包含博客文章的具体内容，因为如果将所有文章内容放进一个文件的话，那么这个文件可能非常大。因而，准备再生成一个 <code>post/</code> 文件夹，下面存放了各个博客文章的具体信息。如果一篇博文标题为 <code>Foo</code>。那么请求 <code>api/post/Foo.json</code> 可以拿到这篇博文的具体信息。</p>
<h3 id="所有的-tags-数据"><a href="#所有的-tags-数据" class="headerlink" title="所有的 tags 数据"></a>所有的 tags 数据</h3><p>类似于 posts 数据，一个 <code>tags</code> 用于说明这个博文下所有的 tag，一个 <code>tag/</code> 文件夹包含每一个 tag 的具体信息（这个 tag 下有哪一些文章）。</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>一些配置信息，比如 siteConfig，和 themeConfig。另外如果有自定义 page 的话，再放一些信息于 <code>page/</code> 文件夹下。</p>
<h1 id="404-处理"><a href="#404-处理" class="headerlink" title="404 处理"></a>404 处理</h1><p>这个是我当时最头疼的一个问题，毕竟 hexo 当初又不是为单页设计的，估计也考虑不到这个问题。</p>
<p>我有一个路由是 <code>/posts</code>。但在 <code>hexo g</code> 运行完后，在 <code>public</code> 目录下面是没有 <code>posts/index.html</code> 这个文件的。因此如果运行 <code>hexo s</code> 的时候，如果直接访问 <code>localhost:4000</code>。那么 hexo 会直接报错，提示 <code>Can not get /posts</code>。如果要解决这个问题，那么我必须在所有可能的路由下生成 <code>index.html</code>。如果我有 100 个路由，那么我需要生成在 100 个文件夹下生成共计 100 个 <code>index.html</code>。</p>
<p>可是这很明显不符合我对 <code>SPA</code> 的预期。按照最初的想法，我只需要一个 <code>index.html</code>。无论浏览器访问哪个路由，后端都能返回同一个 <code>index.html</code>。这一点可以参考 <code>vue-router</code> 官网上对 404 重定向的一个说明 – <a href="https://router.vuejs.org/zh-cn/essentials/history-mode.html" target="_blank" rel="noopener">HTML5 History 模式</a>。</p>
<p>当然我上面这么说的自然原因是我采用了 <code>HTML5 History</code> 模式。我当然可以选择放弃这种模式，采用 URL hash 的方式。也就是说，我的博客地址会变成 <code>/#/post/foo</code> 的样子。但这里又出现了另外一个问题，disqus 对评论的获取是不考虑 <code>#</code> 之后的内容。换句话说，如果用户访问 <code>/#/post/foo</code> 和 <code>/#/post/bar</code> 时，disqus 都会去拿 <code>/</code> 路由对应的评论，所有的页面评论就全部一样了!</p>
<p>因此我不得不再继续思考如何采用上 <code>HTML5 History</code> 模式。如果只考虑部署的话，GitHub Pages 有 404 重定向的方式 (建立 404.html) 以及 nginx 也有类似功能。所有在部署之后是不会有这问题，我需要做的，是对 <code>hexo s</code> 的扩充。</p>
<p><code>hexo</code> 确实开放了对 <code>hexo s</code> 的扩充的接口，结合这个 ISSUE: <a href="https://github.com/hexojs/hexo/issues/1030" target="_blank" rel="noopener">https://github.com/hexojs/hexo/issues/1030</a>。我可以在 <code>hexo s</code> 中实现在 404 时的重定向了。但有两种方案:</p>
<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一:"></a>方案一:</h2>
    <pre><code class="lang-js">hexo.extend.filter.register(<span class="hljs-string">'server_middleware'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_404middleware</span> <span class="hljs-params">(app)</span></span> {
  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle404</span><span class="hljs-params">(req, res, next)</span></span> {
    const s = fs.createReadStream(
      <span class="hljs-built_in">path</span>.resolve(__dirname, <span class="hljs-string">'../../../'</span>, hexo.<span class="hljs-built_in">config</span>.public_dir, <span class="hljs-string">'./index.html'</span>)
    )
    s.pipe(res)
  }, <span class="hljs-number">99</span>)
})
</code></pre>
<p>这种方法，就是直接读取生成好的 index.html 返回。这种方案在大部分情况下可行。</p>
<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二:"></a>方案二:</h2>
    <pre><code class="lang-js">hexo.<span class="hljs-built_in">extend</span>.<span class="hljs-built_in">filter</span>.register(<span class="hljs-string">'server_middleware'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> _404<span class="hljs-title">middleware</span> <span class="hljs-params">(app)</span> {</span>
  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle404</span><span class="hljs-params">(req, res, next)</span> {</span>
    const { pathname } = url.parse(req.url)
    <span class="hljs-keyword">if</span> (!pathname.endsWith(<span class="hljs-string">'.json'</span>)) {
      <span class="hljs-keyword">res</span>.writeHead(<span class="hljs-number">302</span>, {
        <span class="hljs-string">'Location'</span>: url.<span class="hljs-built_in">resolve</span>(hexo.config.root, <span class="hljs-string">'404.html?redirect='</span> + req.url)
      })
      <span class="hljs-keyword">res</span>.end()
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">next</span>()
    }
  }, <span class="hljs-number">99</span>)
})
</code></pre>
<p>其中 99 代表 priority。默认 server 的值为 10。priority 越小越先执行。让默认服务先运行，如果出现 404，那么上面的代码才会执行，进行重定向。注意我增加了一个 <code>redirect</code> 的请求参数，专门用于在前端继续跳转一次。如果不跳转，前端 url 就变成了 <code>/404.html</code>。但我想在当前 URL 下也能显示 404 页面，比如在 <code>/post/xx</code> 页面下显示 404 的内容，而不是跳转到 <code>/404.html</code> 显示。其中注意不要对 <code>json</code> 文件进行处理，仅对一般请求处理即可。</p>
<p>方案二，和方案一相比，两者都不算美观，并不能说是我最满意的方案。但相比之下，方案二，还好一点，原因是方案一一个明显的问题就是，它的成功运行是基于 public 目录下存在 <code>index.html</code> 的前提下。如果这个前提不满足，那么就无法继续。因此我暂时采用了方案二。</p>
<h1 id="页面设计"><a href="#页面设计" class="headerlink" title="页面设计"></a>页面设计</h1><p>上面讲的，其实大多是 hexo 相关内容。至于页面设计就简单多了，因为后端路由已经解决了。前端实际上只是样式的问题。因为当时想做的简单一点，于是才用了 <a href="https://milligram.io/" target="_blank" rel="noopener">milligram</a> 这么一个纯 css 的极简框架。</p>
<p>加上 vue 全家桶，以及 axios 用作异步请求工具，前端开发似乎并没有遇到什么大困难。</p>
<p>唯一可能算的上问题的或许是字体问题吧。原本字体用的是 google fonts 的链接，而总所周知，这在国内体验很不好，因此花了点时间，把字体从网上下载，并写成 css 引用的方式，打包成为主题的一部分。</p>
<h1 id="其它-1"><a href="#其它-1" class="headerlink" title="其它"></a>其它</h1><p>我考虑过要不要加上多语言支持，也就是 <code>i18n</code>。不过感觉没什么必要，并没有那么多需要翻译的。所以这个坑就先留着吧。</p>
<p>在我写这篇文章的时候，<a href="https://hexo.io/themes" target="_blank" rel="noopener">hexo.io/themes</a> 也有了一些其它单页应用的主题，或许未来应该有更多的吧。可能 hexo 未来会对单页应用的博客做一些相关的支持，也可能会出现一款为单页应用博客而定制的博客生成器吧。</p>
<p>另外，记得刚把这个发布并用在自己博客上的时候，有伙伴吐槽 “有点丑呀”。或许吧，和其它主题比起来，确实“朴素”了太多。不过不知道为什么，现在的我确实喜欢这样的“朴素”了呢。</p>
<p>顺便贴一下项目地址，<a href="https://github.com/lazzzis/hexo-theme-only" target="_blank" rel="noopener">hexo-theme-only</a>。欢迎使用和提供批评意见。</p>
<hr>
<p><img src="https://raw.githubusercontent.com/lazzzis/private-static/master/images/sankarea.png?token=AJ4R16LxM7Cb3eb9LnXgz--LkUDNpNCPks5a0RAMwA%3D%3D" alt="散华礼弥"><span class="image-caption">散华礼弥</span></p>

</template>

  </template>
  <script type="text/javascript">
    window.root = "/"
  </script>
  <script src="/js/manifest.js"></script>
  <script src="/js/vendor.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
